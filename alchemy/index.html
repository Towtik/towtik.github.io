<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Infinite Alchemy Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap');

:root {
    --bg-dark: #050508;
    --accent: #3b82f6;
}

body {
    font-family: 'Outfit', sans-serif;
    background-color: var(--bg-dark);
    color: #f8fafc;
    overflow: hidden;
    touch-action: none; /* prevents scroll while dragging on mobile */
}

.workspace {
    background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.05) 1px, transparent 0);
    background-size: 40px 40px;
    width: 100vw;
    height: 100vh;
}

.element-card {
    width: 140px;
    height: 160px;
    background: rgba(30, 41, 59, 0.75);
    backdrop-filter: blur(12px);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: grab;
    position: absolute;
    user-select: none;
}

.element-card:active {
    transform: scale(1.1);
    border-color: var(--accent);
    z-index: 1000;
}

.element-card .emoji { font-size: 4rem; margin-bottom: 10px; }
.element-card .name {
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-size: 0.85rem;
}

.library-item {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 24px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
}

@keyframes combine-glow {
    to { transform: scale(0); opacity: 0; }
}
.combining { animation: combine-glow 0.7s forwards; }

.modal-bg {
    background: rgba(0,0,0,0.92);
}
</style>
</head>

<body class="flex flex-col h-screen">

<div id="workspace" class="workspace relative flex-1 overflow-hidden">

    <div class="absolute top-6 left-6 z-40 flex gap-4">
        <button id="clear-workspace" class="px-6 h-14 rounded-2xl bg-slate-800/80 text-xs font-black">
            <i class="fas fa-trash-alt text-red-400"></i> CLEAR
        </button>
        <button id="reset-game" class="w-14 h-14 rounded-2xl bg-red-900/40">
            <i class="fas fa-rotate-left"></i>
        </button>
    </div>

    <div id="ai-loading" class="hidden absolute inset-0 flex items-center justify-center z-50">
        <div class="text-blue-400 font-black text-xl animate-pulse">Synthesizing...</div>
    </div>
</div>

<div class="h-[40%] bg-slate-950 border-t border-white/10 flex flex-col">
    <div class="p-6 border-b border-white/5 flex justify-between items-center">
        <h2 class="font-black text-xl">
            <i class="fas fa-flask text-blue-400"></i> ELEMENTS
        </h2>
        <span id="count-badge" class="bg-blue-600 px-3 py-1 rounded-full text-xs font-black">4</span>
    </div>
    <div id="library-grid" class="flex-1 overflow-x-auto p-6 flex gap-4"></div>
</div>

<div id="discovery-modal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50">
    <div class="bg-slate-900 p-12 rounded-3xl text-center">
        <div id="disco-emoji" class="text-[6rem] mb-4">âœ¨</div>
        <h2 id="disco-name" class="text-4xl font-black mb-4"></h2>
        <p id="disco-desc" class="text-slate-400 mb-6"></p>
        <button id="collect-btn" class="px-8 py-4 bg-blue-600 rounded-xl font-black">COLLECT</button>
    </div>
</div>

<script>
/* ================= CONFIG ================= */
const GEMINI_API_KEY = "AIzaSyCPWQ3sDVKYS6PGB3b6yX2vrQLQcTceMZ0";
const STORAGE_KEY = "infinite-alchemy-progress";

/* ================= DATA ================= */
const DEFAULT_ELEMENTS = [
    { name: "Water", emoji: "ðŸ’§", desc: "The liquid of life." },
    { name: "Fire", emoji: "ðŸ”¥", desc: "Burning with passion." },
    { name: "Earth", emoji: "ðŸŒ±", desc: "The solid ground." },
    { name: "Air", emoji: "ðŸ’¨", desc: "The breath of the sky." }
];

let library = loadProgress();
let isCombining = false;

/* ================= STORAGE ================= */
function loadProgress() {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved ? JSON.parse(saved) : [...DEFAULT_ELEMENTS];
}
function saveProgress() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(library));
}

/* ================= DOM ================= */
const workspace = document.getElementById("workspace");
const libraryGrid = document.getElementById("library-grid");
const aiLoading = document.getElementById("ai-loading");

/* ================= UI ================= */
function renderLibrary() {
    libraryGrid.innerHTML = "";
    library.forEach(el => {
        const div = document.createElement("div");
        div.className = "library-item w-32 shrink-0";
        div.innerHTML = `<div class="text-4xl">${el.emoji}</div><div class="text-xs font-black">${el.name}</div>`;
        div.onclick = () => spawn(el);
        libraryGrid.appendChild(div);
    });
    document.getElementById("count-badge").innerText = library.length;
}

function spawn(el) {
    const card = document.createElement("div");
    card.className = "element-card";
    card.innerHTML = `<div class="emoji">${el.emoji}</div><div class="name">${el.name}</div>`;
    card.style.left = "50%";
    card.style.top = "50%";
    workspace.appendChild(card);
    drag(card, el);
}

/* ================= DRAG ================= */
function drag(el, data) {
    let ox, oy;

    // Desktop
    el.onmousedown = e => {
        ox = e.offsetX;
        oy = e.offsetY;
        document.onmousemove = m => {
            el.style.left = m.pageX - ox + "px";
            el.style.top = m.pageY - oy + "px";
            checkCollision(el, data);
        };
        document.onmouseup = () => document.onmousemove = null;
    };

    // Mobile
    el.ontouchstart = e => {
        e.preventDefault();
        const touch = e.touches[0];
        ox = touch.clientX - el.offsetLeft;
        oy = touch.clientY - el.offsetTop;

        document.ontouchmove = m => {
            const t = m.touches[0];
            el.style.left = t.clientX - ox + "px";
            el.style.top = t.clientY - oy + "px";
            checkCollision(el, data);
        };

        document.ontouchend = () => document.ontouchmove = null;
    };
}

/* ================= COMBINE ================= */
function checkCollision(active, data) {
    if (isCombining) return;
    document.querySelectorAll(".element-card").forEach(other => {
        if (other === active) return;
        if (Math.hypot(active.offsetLeft - other.offsetLeft, active.offsetTop - other.offsetTop) < 100) {
            combine(active, other, data, { name: other.querySelector(".name").innerText });
        }
    });
}

async function combine(a, b, d1, d2) {
    isCombining = true;
    a.classList.add("combining");
    b.classList.add("combining");
    aiLoading.classList.remove("hidden");

    try {
        const promptText = `Alchemy game.\nMix "${d1.name}" and "${d2.name}".\nReturn ONLY JSON:\n{"name":"Name","emoji":"ðŸ§ª","desc":"Description"}`;

        const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${GEMINI_API_KEY}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }]
                }),
            }
        );

        if (!res.ok) {
            const errorData = await res.json();
            console.error("API Error:", res.status, errorData);
            throw new Error(`HTTP error! status: ${res.status}`);
        }

        const data = await res.json();
        if (!data.candidates) throw "No AI result";

        const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "");
        const result = JSON.parse(text);

        a.remove(); b.remove();

        if (!library.find(x => x.name.toLowerCase() === result.name.toLowerCase())) {
            library.push(result);
            saveProgress();
            showDiscovery(result);
        }
        spawn(result);
        renderLibrary();

    } catch {
        const fallback = {
            name: d1.name + d2.name,
            emoji: "ðŸ§ª",
            desc: "An unstable experimental compound."
        };
        library.push(fallback);
        saveProgress();
        spawn(fallback);
        renderLibrary();
    } finally {
        isCombining = false;
        a.classList.remove("combining");
        b.classList.remove("combining");
        aiLoading.classList.add("hidden");
    }
}

/* ================= MODAL ================= */
function showDiscovery(el) {
    document.getElementById("disco-name").innerText = el.name;
    document.getElementById("disco-emoji").innerText = el.emoji;
    document.getElementById("disco-desc").innerText = el.desc;
    document.getElementById("discovery-modal").classList.remove("hidden");
}

document.getElementById("collect-btn").onclick = () =>
    document.getElementById("discovery-modal").classList.add("hidden");

/* ================= BUTTONS ================= */
document.getElementById("clear-workspace").onclick = () =>
    document.querySelectorAll(".element-card").forEach(e => e.remove());

document.getElementById("reset-game").onclick = () => {
    if (confirm("Reset all progress?")) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
};

/* ================= START ================= */
renderLibrary();
</script>

</body>
</html>
